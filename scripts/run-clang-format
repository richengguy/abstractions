#!/usr/bin/env python3
import argparse
import concurrent.futures
import subprocess
import sys
from concurrent.futures import Future, ThreadPoolExecutor
from dataclasses import dataclass
from difflib import unified_diff
from pathlib import Path
from typing import Iterator, Literal

_IN_TTY = sys.stdout.isatty()


def _ansi_control(s: str, n: int) -> str:
    return f"\033[{n}m{s}\033[m"


def _bold(s: str) -> str:
    return _ansi_control(s, 1) if _IN_TTY else s


def _faint(s: str) -> str:
    return _ansi_control(s, 2) if _IN_TTY else s


def _cyan(s: str) -> str:
    return _ansi_control(s, 36) if _IN_TTY else s


def _green(s: str) -> str:
    return _ansi_control(s, 92) if _IN_TTY else s


def _red(s: str) -> str:
    return _ansi_control(s, 91) if _IN_TTY else s


@dataclass(frozen=True)
class LintResult:
    path: Path
    diff: list[str] | None = None

    @property
    def has_change(self) -> bool:
        return self.diff is not None

    def render(self) -> Iterator[str]:
        if self.diff is None:
            yield f"{_green('\u2713')} ... {self.path.as_posix()}\n"
            return

        for line in self.diff:
            colour = _faint

            if line.startswith(("--- ", "+++ ")):
                colour = _bold
            elif line.startswith("@@ "):
                colour = _cyan
            elif line[0] == "-":
                colour = _red
            elif line[0] == "+":
                colour = _green

            yield colour(line)

        yield "\n"


def collect_files(*paths: Path) -> list[Path]:
    files: list[Path] = []
    for path in paths:
        files.extend(path.glob("**/*.h"))
        files.extend(path.glob("**/*.hpp"))
        files.extend(path.glob("**/*.c"))
        files.extend(path.glob("**/*.cpp"))

    return files


def collect_results(requests: list[Future]) -> list[LintResult]:
    processes = concurrent.futures.wait(requests)
    results: list[LintResult] = [proc.result() for proc in processes.done]
    results.sort(key=lambda x: x.path)
    return results


def dispatch(
    mode: Literal["lint", "format"], config: Path, paths: list[Path]
) -> list[Future]:
    pool = ThreadPoolExecutor(max_workers=4)

    requests: list[Future] = []
    for path in paths:
        match mode:
            case "lint":
                requests.append(pool.submit(lint, config, path))
            case "format":
                raise NotImplementedError()

    return requests


def lint(config: Path, file: Path) -> LintResult:
    output = subprocess.run(
        ["clang-format", f"--style=file:{config}", file.as_posix()],
        capture_output=True,
        text=True,
    )

    if output.returncode != 0:
        raise RuntimeError(output.stderr)

    formatted = output.stdout.splitlines(keepends=True)

    if len(formatted) == 0:
        return LintResult(file)

    with file.open("rt") as f:
        original = f.readlines()

    original_file = f"{file.as_posix()} (original)"
    formatted_file = f"{file.as_posix()} (formatted)"

    diff = list(unified_diff(original, formatted, original_file, formatted_file))
    return LintResult(file, diff)


def main() -> None:
    parser = argparse.ArgumentParser()
    # parser.add_argument("mode", choices=["lint", "format"], help="clang-format mode")
    parser.add_argument(
        "paths", metavar="path", nargs="+", help="source code path", type=Path
    )
    parser.add_argument("--check", action="store_true", help="Return a non-zero exit code if there are any code changes.")
    parser.add_argument("--diff", action="store_true", help="Only show the proposed changes.")

    parser.add_argument("--config", "-c", default=Path(".clang-format"), type=Path)
    args = parser.parse_args()

    files = collect_files(*args.paths)
    requests = dispatch("lint", args.config, files)
    results = collect_results(requests)

    has_changes = False
    for result in results:
        has_changes |= result.has_change
        sys.stdout.writelines(result.render())

    if args.check and has_changes:
        sys.exit(1)


if __name__ == "__main__":
    main()
